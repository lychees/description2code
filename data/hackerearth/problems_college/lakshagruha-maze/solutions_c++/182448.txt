#include <stdio.h>

main()
{
int fall;
for(scanf("%d",&fall); fall--;)
	{
	int m, n, c, k, i=0;
	int o[30]={0}, a1[30]={0}, a2[30]={0};
	int v[2], w[30][300][2], v1[30], w1[30];
	int *s1, *s2, *st;
	for(scanf("%d %d %d %d",&m,&n,&c,&k); i<c; i++)
		{
		int j, l, x1, y1, x, y;
		if(scanf("%d",&l)&&!(v1[i]=w1[i]=0)&&l)
			for(j=0; j<=l; j++)
				{
				if(j==l)
					{
					x=w[i][0][0];
					y=w[i][0][1];
					}
				else
					scanf("%d %d",&y,&x);
				if(j>0)
					{
					for(;x1<x; w[i][v1[i]][0]=x1++,w[i][v1[i]][1]=y,v1[i]++);
					for(;x1>x; w[i][v1[i]][0]=x1--,w[i][v1[i]][1]=y,v1[i]++);
					for(;y1<y; w[i][v1[i]][0]=x,w[i][v1[i]][1]=y1++,v1[i]++);
					for(;y1>y; w[i][v1[i]][0]=x,w[i][v1[i]][1]=y1--,v1[i]++);
					}
				else
					{
					x1=x;
					y1=y;
					}
				}
		}
	for(s1=a1,s2=a2,i=0; i<m; i++)
		{
		int j=0;
		char niz[31];
		for(scanf("%s",niz); j<n; j++)
			switch(niz[j])
				{
				case 'X' : o[i]|=1<<j; break;
				case 'E' : v[0]=i; v[1]=j; break;
				case 'P' : s1[i]=1<<j; break;
				}
		o[i]=~o[i];
		}
	for(i=0;;)
		{
		int j;
		if(i>=k)
			{
			printf("-1\n");
			break;
			}
		for(j=-1; ++j<m; s2[j]=(s1[j]|s1[j]<<1|s1[j]>>1|(j-1>=0?s1[j-1]:0)|(j+1<m?s1[j+1]:0))&o[j],s2[j]&=~(1<<n));
		for(j=-1; ++j<c; s2[w[j][w1[j]][0]]&=~(1<<w[j][w1[j]][1]),w1[j]++,w1[j]=w1[j]==v1[j]?0:w1[j],s2[w[j][w1[j]][0]]&=~(1<<w[j][w1[j]][1]));
		i++;
		if(s2[v[0]]&(1<<v[1]))
			{
			printf("%d\n",i);
			break;
			}
		st=s1;
		s1=s2;
		s2=st;
		}
	}
return 0;
}

