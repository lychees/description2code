#include <bits/stdc++.h>
#define MAX 1000006
using namespace std;
vector<int> gr[MAX];
vector<pair<int,int> > v;
int visit[MAX];
int grp[MAX];
int grpno;
void bfs(int ver)
{
    if(grp[ver]!=0)
        return;
    queue<int> q;
    q.push(ver);
    vector<int>::iterator it;
    while(!q.empty())
    {
        ver=q.front();
        q.pop();
        visit[ver]=1;
        grp[ver]=grpno;
        for(it=gr[ver].begin();it!=gr[ver].end();it++)
        {
            if(!visit[*it])
            {
                q.push(*it);
            }
        }
    }
    grpno++;
}

int main(int argc, char const *argv[]) {
    int test,n,k,a,b;
    int i,j;
    char ch;
    scanf("%d",&test);
    while(test--)
    {
        scanf("%d%d",&n,&k);
        for(i=0;i<n+4;i++)
            gr[i].clear();
        grpno=1;
        for(i=0;i<=n;i++)
        {
            visit[i]=0;
            grp[i]=0;
        }
        v.clear();
        while(k--)
        {
            scanf("%d %c",&a,&ch);
            if(ch=='!')
            {
                scanf("%c %d",&ch,&b);
                v.push_back(make_pair(a,b));
            }
            else
            {
                scanf("%d",&b);
                gr[a].push_back(b);
                gr[b].push_back(a);
            }
        }
        for(i=1;i<=n;i++)
            bfs(i);
        vector<pair<int,int> >::iterator it;
        int flag=0;
        for(it=v.begin();it!=v.end();it++)
        {
            pair<int,int> temp;
            temp=*it;
            if(grp[temp.first]==grp[temp.second])
            {
                printf("NO\n");
                flag=1;
                break;
            }
        }
        if(!flag)
            printf("YES\n");
        // printf("%d %c %d\n",a,ch,b);
    }
    return 0;
}
