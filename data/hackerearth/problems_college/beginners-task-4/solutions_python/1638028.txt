def power1(x,n,MOD):
    if(n==0):
    	return 1
    ret=1
    while(n):
	if(n&1):
		ret*=x
		ret%=MOD
	x*=x
	x%=MOD
	n>>=1
    return ret
T=input()
while(T):
	T-=1
	N,K,M,W=map(int,raw_input().split())
	L=map(int,raw_input().split())
	prod=1
	for x in xrange(N):
		prod=prod*L[x]%W
		if((x+1)%K==0):
			prod=power1(prod,M,W)
			prod%=W
		if(prod==0):
			break
	print prod%W
		